name: E2E Tests
run-name: E2E Tests for NSC Events

on:
  push:
    branches: [main]
    paths:
      - "nsc-events-nextjs/**"
      - "nsc-events-nestjs/**"
      - "e2e/**"
      - "playwright.config.ts"
      - ".github/workflows/e2e-tests.yml"
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "nsc-events-nextjs/**"
      - "nsc-events-nestjs/**"
      - "e2e/**"
      - "playwright.config.ts"
      - ".github/workflows/e2e-tests.yml"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: nsc_events
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 22
        uses: actions/setup-node@v3
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Clean install dependencies
        run: HUSKY=0 npm ci --include=optional

      - name: Install sharp for Linux platform
        run: npm install --os=linux --cpu=x64 sharp
        working-directory: ./nsc-events-nestjs

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npm ls @playwright/test --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps

      - name: Build backend
        run: npm run build:backend

      - name: Build frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000/api
        run: npm run build:frontend

      - name: Wait for database
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres; then
              echo "Database is ready"
              exit 0
            fi
            echo "Attempt $i: Database not ready yet..."
            sleep 2
          done
          echo "Database did not become ready in time"
          exit 1

      - name: Run E2E tests
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:8080
          PLAYWRIGHT_API_URL: http://localhost:3000/api
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DATABASE: nsc_events
          NODE_ENV: test
          JWT_SECRET: e2e-test-jwt-secret-key
        run: npm run test:e2e

      - name: Archive Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 30

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'test-results/results.json';
            if (!fs.existsSync(resultsPath)) {
              return;
            }
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const totalTests = results.stats?.expected || 0;
            const passedTests = results.stats?.expected - results.stats?.unexpected || 0;
            const failedTests = results.stats?.unexpected || 0;


            let comment = `## E2E Test Results\n\n`;
            comment += `- Total: ${totalTests}\n`;
            comment += `- Passed:  ${passedTests}\n`;
            comment += `- Failed:  ${failedTests}\n\n`;
            comment += `[View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;


            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
            });

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./test-results/junit.xml
          fail_ci_if_error: false
          verbose: true
